<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SAE Teensy ECU: FlexCAN_T4</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="custom_dark_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SAE Teensy ECU
   </div>
   <div id="projectbrief">SAE 2020 Microcontroller programming</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__c___users__isaias__desktop__i_i_t__s_a_e__s_a_e_git__e_c_u2020__teensy36__m_c_u__testing_libb83f988013d621f4bcf7ba8bdac6cfab.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_flex_c_a_n___t4.html">FlexCAN_T4</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>FlexCAN Library for Teensy 4</p>
<p><a href="https://forum.pjrc.com/threads/56035-FlexCAN_T4-FlexCAN-for-Teensy-4">https://forum.pjrc.com/threads/56035-FlexCAN_T4-FlexCAN-for-Teensy-4</a></p>
<p>Designed for Teensy 4.0, compatibility for Teensy 3.x. Based on a redesigned model of IFCT from the ground up.</p>
<p>Your sketch should include the header to use it:</p>
<p><code>#include &lt;<a class="el" href="_flex_c_a_n___t4_8h_source.html">FlexCAN_T4.h</a>&gt;</code></p>
<p>There are 2 types of template constructors available. CAN2.0 and CANFD use a different constructor.</p>
<p>To use CAN2.0 mode, use: </p><div class="fragment"><div class="line">FlexCAN_T4&lt;CAN3, RX_SIZE_256, TX_SIZE_16&gt; myCan;</div>
</div><!-- fragment --><p>Where on Teensy4, CAN1,CAN2, and CAN3 are available. On Teensy 3.x, CAN0 is available on all, but CAN1 exists only on Teensy 3.6. The name of myCan can be anything of your choice.</p>
<p>To use CANFD mode, use: </p><div class="fragment"><div class="line">FlexCAN_T4FD&lt;CAN3, RX_SIZE_256, TX_SIZE_16&gt; myFD;</div>
</div><!-- fragment --><p>Where, on Teensy 4.0, only CAN3 supports FD. Teensy3.x does not have an FD controller at all. Again, the name of myFD can be anything of your choice.</p>
<p>Before using any of the commands of the library, <a class="el" href="namespace_state.html#a1c6e60c84c0fb7c572adaf678fb6a56a" title="Begin the state machine with a pointer to a state.">myCan.begin()</a> must absolutely be called, at a bare minimum to set up the clock and controller. Skipping this first step will hard fault teensy if the registers are not configured.</p>
<p>There are 2 different configurations for baudrates between CAN2.0 and CANFD. To set baudrate in CAN2.0 mode, you need to call: </p><div class="fragment"><div class="line">myCan.setBaudRate(1000000);</div>
</div><!-- fragment --><p>Where 1000000 is the bitrate of your choice.</p>
<p>To set baudrate in CANFD mode, you need to call:</p>
<div class="fragment"><div class="line">CANFD_timings_t config;</div>
<div class="line">config.clock = CLK_24MHz;</div>
<div class="line">config.baudrate = 1000000;</div>
<div class="line">config.baudrateFD = 2000000;</div>
<div class="line">config.propdelay = 190;</div>
<div class="line">config.bus_length = 1;</div>
<div class="line">config.sample = 70;</div>
<div class="line">FD.setBaudRate(config);</div>
</div><!-- fragment --><p>There are 2 different message structures for CAN2.0 and CANFD.</p>
<p>CANFD: <code><a class="el" href="struct_c_a_n_f_d__message__t.html">CANFD_message_t</a></code></p>
<p>CAN2.0: <code><a class="el" href="struct_c_a_n__message__t.html">CAN_message_t</a></code></p>
<p>Both are very similar, except CANFD structure has a 64 byte payload, edl, and brs switching.</p>
<p>brs by default is set to 1, unless changed in the message structure. This bit, when set, allows the higher bitrate for data to be used in CANFD mode, otherwise nominal rate is used.</p>
<p>edl by default is set to 1, unless changed in the message structure. This bit, when set, allows CANFD frames to be sent, otherwise, sends as a CAN2.0 frame, with a truncated payload to max 8 bytes.</p>
<p>Callbacks for interrupts can be used, both for individual mailboxes, or for all mailboxes.</p>
<div class="fragment"><div class="line">myCan.onReceive(MB0, canSniff); // allows mailbox 0 messages to be received in the supplied callback.</div>
<div class="line">myCan.onReceive(MB1, canSniff); // allows mailbox 1 messages to be received in the supplied callback.</div>
<div class="line">myCan.onReceive(canSniff); // allows all FIFO/message box messages to be received in the supplied callback.</div>
<div class="line">myCan.onReceive(FIFO, canSniff); // allows FIFO messages to be received in the supplied callback.</div>
</div><!-- fragment --><p>Note that there is no FIFO support in CANFD for Teensy 4.0. FIFO is only supported in CAN2.0 mode on Teensy 3.x and Teensy 4.0</p>
<p>To enable FIFO support in CAN2.0 mode, simply run myCAN.enableFIFO();</p>
<p>Each mailbox can be interrupt enabled or all at once. This allows frames to be interrupt driven rather than polling them in the loop. </p><div class="fragment"><div class="line">myCan.enableMBInterrupts(); // enables all mailboxes to be interrupt enabled</div>
<div class="line">myCan.enableMBInterrupt(MB4); // enables mailbox 4 to be interrupt enabled</div>
<div class="line">myCan.enableMBInterrupt(FIFO); // enables FIFO to be interrupt enabled</div>
</div><!-- fragment --><p>A general callback printout for CAN2.0 and CANFD is the following (remove the FD from CANFD for the message structure if using CAN2.0 mode): </p><div class="fragment"><div class="line">void canSniff(const CANFD_message_t &amp;msg) {</div>
<div class="line">  Serial.print(&quot;MB &quot;); Serial.print(msg.mb);</div>
<div class="line">  Serial.print(&quot;  OVERRUN: &quot;); Serial.print(msg.flags.overrun);</div>
<div class="line">  Serial.print(&quot;  LEN: &quot;); Serial.print(msg.len);</div>
<div class="line">  Serial.print(&quot; EXT: &quot;); Serial.print(msg.flags.extended);</div>
<div class="line">  Serial.print(&quot; TS: &quot;); Serial.print(msg.timestamp);</div>
<div class="line">  Serial.print(&quot; ID: &quot;); Serial.print(msg.id, HEX);</div>
<div class="line">  Serial.print(&quot; Buffer: &quot;);</div>
<div class="line">  for ( uint8_t i = 0; i &lt; msg.len; i++ ) {</div>
<div class="line">    Serial.print(msg.buf[i], HEX); Serial.print(&quot; &quot;);</div>
<div class="line">  } Serial.println();</div>
<div class="line">}</div>
</div><!-- fragment --><p>To get an idea of a default initialization of the mailboxes, you may run: </p><div class="fragment"><div class="line">myCan.mailboxStatus();</div>
</div><!-- fragment --><p>It will show you how many standard, extended, transmit mailboxes you have, and if fifo is enabled or not.</p>
<p>There is a complex filtering system in the FIFO region, which is not very user friendly. If you have FIFO enabled, running mailboxStatus will show you how many filters that you can set for it. The library fully automates the masking capability in both hardware and software, taking the struggle away from the users. Usually, when you are setting filters, your first step would be to block all data first before setting the filters. To do this, you would need to use:</p>
<p>For FIFO: <code>myCan.setFIFOFilter(REJECT_ALL);</code></p>
<p>For mailboxes: <code>myCan.setMBFilter(REJECT_ALL);</code></p>
<p>Once this is done, you may configure your filters to allow a specific ID, a group (up to 5 IDs), or even a range of IDs. </p><div class="fragment"><div class="line">myCan.setFIFOFilter(0, 0x123, STD); // Set filter0 to allow STANDARD CAN ID 0x123 to be collected by FIFO. </div>
<div class="line">myCan.setFIFOFilter(1, 0x456, EXT); // Set filter1 to allow EXTENDED CAN ID 0x456 to be collected by FIFO. </div>
<div class="line">myCan.setMBFilter(MB6, 0x123); // Set mailbox 6 to allow CAN ID 0x123 to be collected. </div>
</div><!-- fragment --><p>For the mailbox, there is no extended or standard selection. Those bits are set on the mailbox and referred to when applying the filter. To see what type of mailbox you have, <code>run mailboxStatus();</code>. </p><div class="fragment"><div class="line">myCan.setMBFilterRange(MB7, 0x1, 0x9); // Mailbox will attept to receive only frames 0x1 to 0x5.</div>
</div><!-- fragment --><p>(0x1,0x2,0x3,0x4,0x5, and other frames may bleed-thru, see enhanceFilter for sub-filtering)</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Enhanced filtering</h2>
<p>Enhanced filtering is a feature of the library that can stop bleed-thru frames from a multi-ID filter to store messages of IDs that were not requested to the queue. Lets say for example you want a mailbox to store IDs 0x1 and 0x5: </p><div class="fragment"><div class="line">myCan.setMBFilter(MB6, 0x1, 0x5);</div>
</div><!-- fragment --><p>You will notice that not only frames 0x1 and 0x5 are received, but also 0x3 and 0x7. This is because the 2 out of 3 bits are different between both IDs. Once you enable: </p><div class="fragment"><div class="line">myCan.enhanceFilter(MB6);</div>
</div><!-- fragment --><p>The library will toss out those frames and keep only the ones you requested. So while the hardware does most of the filtering, the library is the final filtering system which allows what you actually wanted to be saved. This can be applied to all FIFO filters as well. </p><div class="fragment"><div class="line">myCan.enhanceFilter(FIFO);</div>
</div><!-- fragment --><p>Distribution, on all controllers, the first mailbox/FIFO to receive a frame is a first come, first serve, and if you have other mailboxes capturing the same type of frame, especially with individual callbacks, not all will fire, but only one. Distribution overcomes this limitation by copying the frame to the queue if it matches another mailbox filter, allowing all similar filters to receive the same message. </p><div class="fragment"><div class="line">myCan.distribute(); // Enable distribution</div>
</div><!-- fragment --><p>The mailbox type can be changed to extended, standard, or transmit, using the setMB() function. </p><div class="fragment"><div class="line">myCan.setMB(MB9,TX); // Set mailbox as transmit</div>
<div class="line">myCan.setMB(MB10,RX,EXT); // Set mailbox as receiving extended frames.</div>
<div class="line">myCan.setMB(MB11,RX,STD); // Set mailbox as receiving standard frames.</div>
</div><!-- fragment --><p>Events must be used in the loop(), IntervalTimer, or teensyThreads, for the callback system to push received interrupt frames from the queue to the callback. Sequential frames are pushed out from there as well, we'll talk about that soon. </p><div class="fragment"><div class="line">myCan.events();</div>
</div><!-- fragment --><p>Sequential frames, if you want to send ordered frames out without bus arbitration making them go out in any order, the library supports sending your frames out from a queue to the absolute first transmit mailbox only. To enable sequential support, set your message structure to msg.seq = 1, then write it as normal, the library will only queue it for next cycle if the mailbox isn't available.</p>
<p>The recommended pins on the teensy cards for CAN are used by default. If you wish to switch to alternate pins, you can use <code>myCan.setRX(ALT);</code> or <code>myCAN.setTX(ALT)</code> as needed.</p>
<p>Polling frames is possible and won't touch interrupt driven mailboxes. You may use your correct message structure (<a class="el" href="struct_c_a_n__message__t.html">CAN_message_t</a> or <a class="el" href="struct_c_a_n_f_d__message__t.html">CANFD_message_t</a>), and simply call: <code>myCan.read(myFrame);</code> If FIFO is enabled, each read() call will read from FIFO or Mailbox randomly, provided they are not interrupt driven.</p>
<p>There are 2 functions to write messages to the bus: </p><div class="fragment"><div class="line">myCan.write(myFrame); // Write to any available transmit mailbox, Note, sequential frames must use this function only.</div>
<div class="line">myCan.write(MB15, myFrame); // Write to mailbox 15 (provided it&#39;s a transmit mailbox)</div>
</div><!-- fragment --><p>FIFO does NOT transmit, only mailboxes do.</p>
<p>In the background, the library has 3 weak functions used for interrupt driven frames, that can be used by other libraries to gather data for their own functionality. An example of this is TeensyCAN, which uses one of the 3 weak functions, leaving 2 available for other libraries, if needed.</p>
<div class="fragment"><div class="line">extern void ext_outputFD1(const CANFD_message_t &amp;msg); // Interrupt data output, not filtered, for external libraries, FD</div>
<div class="line">extern void ext_outputFD2(const CANFD_message_t &amp;msg);</div>
<div class="line">extern void ext_outputFD3(const CANFD_message_t &amp;msg); // TeensyCAN uses this one.</div>
<div class="line">extern void ext_output1(const CAN_message_t &amp;msg); // Interrupt data output, not filtered, for external libraries, CAN2.0</div>
<div class="line">extern void ext_output2(const CAN_message_t &amp;msg);</div>
<div class="line">extern void ext_output3(const CAN_message_t &amp;msg); // TeensyCAN uses this one.</div>
</div><!-- fragment --><p>On Teensy 4, you have actually 64 mailboxes in CAN2.0 mode, but in CANFD mode, depending on the data size, can be much less. When setting the region support of the mailbox for FD mode (setRegion(x)), the function returns the count of mailboxes available to the user. </p><div class="fragment"><div class="line">myFD.setRegion(8) // default, returns a value of 64 (mailboxes), each one supporting 8 bytes payload</div>
<div class="line">myFD.setRegion(64) // returns a value of 14 (mailboxes), each one supporting 64 bytes payload</div>
</div><!-- fragment --><p>In CAN2.0 mode, setRegion doesn't exist, you have 64 mailboxes on Teensy 4.0, and 16 on Teensy 3.x. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
